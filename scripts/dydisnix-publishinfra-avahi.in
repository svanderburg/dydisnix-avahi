#!/bin/bash -e

# Generates key=value assignments from the configuration expression generated by dysnomia-containers
generateConfig()
{
    export IFS=''

    dysnomia-containers --generate-expr | while read -r line
    do
        if [ "$containerFollows" = "1" ]
        then
            if [ "$line" = "  };" ]
            then
                containerFollows=
            else
                container=${line:4:-4}
                prefix="$prefix.$container."
            fi
        elif [ "$line" = "{" ] || [ "$line" = "}" ]
        then
            true
        elif [ "$line" = "  properties = {" ]
        then
            prefix="properties."
        elif [ "$line" = "  };" ]
        then
            prefix=""
        elif [ "$line" = "  containers = {" ]
        then
            prefix="containers."
            containerFollows=1
        else
            if [ "$containerFollows" = "1" ]
            then
                assignment=$(echo "${line:6:-1}" | sed 's/" = /"=/')
            else
                assignment=$(echo "${line:4:-1}" | sed 's/" = /"=/')
            fi
            
            echo "'$prefix$assignment'"
        fi
    done
}

# Start the avahi service publisher with the generated configuration properties
(echo "disnix-$(hostname)"; echo "_disnix._tcp 22"; generateConfig) | xargs @avahi_publish_service@
